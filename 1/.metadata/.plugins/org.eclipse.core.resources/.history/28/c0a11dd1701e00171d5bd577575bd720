<?php
/*
 * iTech Empires: PHP State Management Script
 * Version: 1.0.0
 * Page: Login
 */

session_start(); // starting a session

// check session is set (if user is already login, redirect to the profile page)
if($_SESSION['id'])
{
	header("location: adminPanel.php");
	exit;
}

$error_message = "";
// check for form submit action
if(isset($_POST['email']) && isset($_POST['password']))
{
	// basic input validation
	if($_POST['email'] == "" && $_POST['password'] == "")
	{
		$error_message = "Please enter your login details!";
	}
	else
	{
		// validate user ( if successfully validated, redirect to the profile page)
		include("script/db_connection.php");
		$email = mysqli_real_escape_string($con, $_POST['email']);
		$password = md5(mysqli_real_escape_string($con, $_POST['password']));

		$query = "SELECT * FROM users WHERE email = '$email' AND password = '$password'";
		if(!$result = mysqli_query($con, $query))
		{
			exit(mysqli_error($con));
		}

		if(mysqli_num_rows($result) > 0)
		{
			// Login successfully
			while($row = mysqli_fetch_assoc($result))
			{
				// set sessions variable with the user details
				$_SESSION['id'] =  $row['id'];
				$_SESSION['first_name'] =  $row['first_name'];
				$_SESSION['last_name'] =  $row['last_name'];
				$_SESSION['email'] =  $row['email'];
			}

			// redirect to the secure page ex. user profile
			header("location: user_profile.php");
			exit;
		}
		else
		{
			// show error message
			$error_message = "Invalid login details, Please try again!";
		}
	}
}
?>