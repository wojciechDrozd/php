<?php

if(isset($_POST['class_name']) && $_POST['class_name'] != ""){
	
	//połączenie z bazą
	require_once 'db_connection.php';
	$class_name = $_POST['class_name'];
	
	//nagłówek tabeli lista obecności
	$data = <<<EOD
	<table class="table table-bordered table-striped">
			<tr>
				<th colspan="7">$class_name</th>
			</tr>
			<tr>
				<th>Nr albumu</th>
				<th>Nazwisko</th>
				<th>Imię</th>
EOD;
	
	$query ="SELECT * FROM 
	((grafik INNER JOIN przedmioty ON grafik.idprzedmiot=przedmioty.idprzedmiot)
	INNER JOIN zajecia ON grafik.idzajecia=zajecia.idzajecia)
			WHERE nazwaPrzedmiotu='$class_name' ORDER BY data ASC";
	$result = mysqli_query($con, $query);
	
	$allDates = array();
	while($row=mysqli_fetch_assoc($result)){
		$data .= '<th>'.$row['data'].' ('.$row['nazwa'].') '.'</th>';
		$allDates[] = $row['data'];
	}
	$data .= '</tr>';
	mysqli_free_result($result);

	$query ="SELECT * FROM
	((lista_obecnosci INNER JOIN studenci ON lista_obecnosci.nrAlbumu=studenci.nrAlbumu)
	INNER JOIN przedmioty ON lista_obecnosci.przedmioty_idprzedmiot=przedmioty.idprzedmiot)
	WHERE nazwaPrzedmiotu='$class_name'";
	
	$result = mysqli_query($con, $query);
	
	while($row = mysqli_fetch_assoc($result)){
		
		$data .= '<tr>
				<td>'.$row['nrAlbumu'].'</td>
				<td>'.$row['nazwisko'].'</td>
				<td>'.$row['imie'].'</td>';
		
				foreach ($allDates as $date){
					
					$query2 = "SELECT obecny FROM lista_obecnosci
							WHERE nrAlbumu={$row['nrAlbumu']} AND przedmiot_data='$date'";
					$result2 = mysqli_query($con, $query2);
					$row2 = mysqli_fetch_assoc($result2);
					$data .= '<td>'.$row['obecny'].'</td>';
					}
				
					$data .= '</tr>';
				}
		
		
		
	}
	for ($i =0; $i < count($allDates); $i++){
		
		$query ="SELECT * FROM
		 ((lista_obecnosci INNER JOIN studenci ON lista_obecnosci.nrAlbumu=studenci.nrAlbumu)
		 INNER JOIN przedmioty ON lista_obecnosci.przedmioty_idprzedmiot=przedmioty.idprzedmiot)
		 WHERE przedmiot_data='{$allDates[$i]}'";
		
		 $result = mysqli_query($con, $query);
		
		 while($row = mysqli_fetch_assoc($result)){
		 $data .= '<tr><td>'.$row['obecny'].'</td></tr>';
		 }
		
		
	}

	
	
	$data .= '</table>';
	
	echo $data;
	
	print_r($allDates);

	
}
?>